var ae=Object.defineProperty;var ce=(e,t,o)=>t in e?ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var M=(e,t,o)=>ce(e,typeof t!="symbol"?t+"":t,o);import{F as ue,G as de,I as E,J as le,K as fe,L as z,M as me}from"./index-CrXQ4ZbO.js";import{a as c,_ as R}from"./objectSpread2-t4yaKxP6.js";import"./index-D4sVUtYa.js";import"./index.browser.esm-344Elki9.js";class C{constructor(t){M(this,"ttl");M(this,"map",new Map);M(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,j()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,he(this)},0))}clear(){this.map.clear()}}function he(e){const t=j()-e.ttl,o=e.map[Symbol.iterator]();for(;;){const s=o.next().value;if(!s)return;const n=s[0];if(s[1]<t)e.map.delete(n);else return}}function j(){return Date.now()}function ge(e){return!!(e&&typeof e.then=="function")}Promise.resolve(!1);Promise.resolve(!0);const p=Promise.resolve();function L(e,t){return e||(e=0),new Promise(o=>{setTimeout(()=>o(t),e)})}function pe(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function w(){return Math.random().toString(36).substring(2)}let S=0;function h(){let e=Date.now()*1e3;return e<=S&&(e=S+1),S=e,e}const l=ue.getLogger("broadcast-channel");l.setLevel("error");const _e="https://api.web3auth.io/session-service",ve="https://session.web3auth.io";function k(e={}){const t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),t.server||(t.server={}),t.server.api_url||(t.server.api_url=`${_e}/v2`),t.server.socket_url||(t.server.socket_url=`${ve}`),t.server.removeTimeout||(t.server.removeTimeout=1e3*60*5),e.methods&&(t.methods=e.methods),t}const ye=h,we="pubkey.broadcast-channel-0-",f="messages",_={durability:"relaxed"},be="idb";function I(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){const e=window;if(typeof e.mozIndexedDB<"u")return e.mozIndexedDB;if(typeof e.webkitIndexedDB<"u")return e.webkitIndexedDB;if(typeof e.msIndexedDB<"u")return e.msIndexedDB}return!1}function b(e){e.commit&&e.commit()}function F(e){const t=I();if(!t)return Promise.reject(new Error("IndexedDB not available"));const o=we+e,s=t.open(o);return s.onupgradeneeded=r=>{r.target.result.createObjectStore(f,{keyPath:"id",autoIncrement:!0})},new Promise((r,i)=>{s.onerror=a=>i(a),s.onsuccess=()=>{r(s.result)}})}function J(e,t,o){const s=Date.now(),n={uuid:t,time:s,data:o},r=e.transaction([f],"readwrite",_);return new Promise((i,a)=>{r.oncomplete=()=>i(),r.onerror=d=>a(d),r.objectStore(f).add(n),b(r)})}function Me(e){const t=e.transaction(f,"readonly",_),o=t.objectStore(f),s=[];return new Promise(n=>{o.openCursor().onsuccess=r=>{const i=r.target.result;i?(s.push(i.value),i.continue()):(b(t),n(s))}})}function V(e,t){const o=e.transaction(f,"readonly",_),s=o.objectStore(f),n=[];let r=IDBKeyRange.bound(t+1,1/0);if(s.getAll){const a=s.getAll(r);return new Promise((u,d)=>{a.onerror=g=>d(g),a.onsuccess=function(g){u(g.target.result)}})}function i(){try{return r=IDBKeyRange.bound(t+1,1/0),s.openCursor(r)}catch{return s.openCursor()}}return new Promise((a,u)=>{const d=i();d.onerror=g=>u(g),d.onsuccess=g=>{const m=g.target.result;m?m.value.id<t+1?m.continue(t+1):(n.push(m.value),m.continue()):(b(o),a(n))}})}function W(e,t){const s=e.transaction([f],"readwrite",_).objectStore(f);return Promise.all(t.map(n=>{const r=s.delete(n);return new Promise(i=>{r.onsuccess=()=>i()})}))}function q(e,t){const o=Date.now()-t,s=e.transaction(f,"readonly",_),n=s.objectStore(f),r=[];return new Promise(i=>{n.openCursor().onsuccess=a=>{const u=a.target.result;if(u){const d=u.value;d.time<o?(r.push(d),u.continue()):(b(s),i(r))}else i(r)}})}function H(e,t){return q(e,t).then(o=>W(e,o.map(s=>s.id)))}function ke(e,t){return t=k(t),F(e).then(o=>{const s={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:w(),eMIs:new C(t.idb.ttl*2),writeBlockPromise:p,messagesCallback:null,readQueuePromises:[],db:o,time:h()};return o.onclose=function(){s.closed=!0,t.idb.onclose&&t.idb.onclose()},X(s),s})}function X(e){e.closed||Y(e).then(()=>L(e.options.idb.fallbackInterval)).then(()=>X(e)).catch(t=>{throw t})}function Se(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function Y(e){return e.closed||!e.messagesCallback?p:V(e.db,e.lastCursorId).then(t=>(t.filter(s=>!!s).map(s=>(s.id>e.lastCursorId&&(e.lastCursorId=s.id),s)).filter(s=>Se(s,e)).sort((s,n)=>s.time-n.time).forEach(s=>{e.messagesCallback&&(e.eMIs.add(s.id),e.messagesCallback(s.data))}),p))}function Ee(e){e.closed=!0,e.db.close()}function Pe(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(()=>J(e.db,e.uuid,t)).then(()=>(pe(0,10)===0&&H(e.db,e.options.idb.ttl),p)),e.writeBlockPromise}function Ce(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t,Y(e)}function Le(){return!!I()}function Ie(e){return e.idb.fallbackInterval*2}const Te=Object.freeze(Object.defineProperty({__proto__:null,TRANSACTION_SETTINGS:_,averageResponseTime:Ie,canBeUsed:Le,cleanOldMessages:H,close:Ee,commitIndexedDBTransaction:b,create:ke,createDatabase:F,getAllMessages:Me,getIdb:I,getMessagesHigherThan:V,getOldMessages:q,microSeconds:ye,onMessage:Ce,postMessage:Pe,removeMessagesById:W,type:be,writeMessage:J},Symbol.toStringTag,{value:"Module"})),$e=h,Be="pubkey.broadcastChannel-",G="localstorage";function T(){let e=null;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function $(e){return Be+e}function Ne(e,t){return new Promise((o,s)=>{L().then(()=>{var n;const r=$(e.channelName),i={token:w(),time:Date.now(),data:t,uuid:e.uuid},a=JSON.stringify(i);(n=T())===null||n===void 0||n.setItem(r,a);const u=document.createEvent("StorageEvent");u.initStorageEvent("storage",!0,!0,r,null,a,"",null),window.dispatchEvent(u),o()}).catch(s)})}function Q(e,t){const o=$(e),s=n=>{n.key===o&&n.newValue&&t(JSON.parse(n.newValue))};return window.addEventListener("storage",s),s}function Z(e){window.removeEventListener("storage",e)}function ee(){const e=T();if(!e)return!1;try{const t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function De(e,t){const o=k(t);if(!ee())throw new Error("BroadcastChannel: localstorage cannot be used");const s=w(),n=new C(o.localstorage.removeTimeout),r={channelName:e,uuid:s,time:h(),eMIs:n};return r.listener=Q(e,i=>{r.messagesCallback&&i.uuid!==s&&(!i.token||n.has(i.token)||i.data.time&&i.data.time<(r.messagesCallbackTime||0)||(n.add(i.token),r.messagesCallback(i.data)))}),r}function Re(e){e.listener&&Z(e.listener)}function xe(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t}function Oe(){const t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?120*2:120}const Ae=Object.freeze(Object.defineProperty({__proto__:null,addStorageEventListener:Q,averageResponseTime:Oe,canBeUsed:ee,close:Re,create:De,getLocalStorage:T,microSeconds:$e,onMessage:xe,postMessage:Ne,removeStorageEventListener:Z,storageKey:$,type:G},Symbol.toStringTag,{value:"Module"})),Ke=h,te="native";function Ue(e){const t={time:h(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=o=>{t.messagesCallback&&t.messagesCallback(o.data)},t}function ze(e){e.bc.close(),e.subFns=[]}function je(e,t){try{return e.bc.postMessage(t),p}catch(o){return Promise.reject(o)}}function Fe(e,t){e.messagesCallback=t}function Je(){if(typeof window>"u")return!1;if(typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1}function Ve(){return 150}const We=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:Ve,canBeUsed:Je,close:ze,create:Ue,microSeconds:Ke,onMessage:Fe,postMessage:je,type:te},Symbol.toStringTag,{value:"Module"})),qe=h,He="pubkey.broadcastChannel-",se="server";let v=null;const y=new Set;function B(e){return He+e}function Xe(e,t){return new Promise((o,s)=>{L().then(async()=>{const n=B(e.channelName),r=E(Buffer.from(n,"utf8")),i=await le(r.toString("hex"),{token:w(),time:Date.now(),data:t,uuid:e.uuid}),a={allowedOrigin:e.server.allowed_origin,sameIpCheck:!0,key:z(r).toString("hex"),data:i,signature:(await fe(r,E(Buffer.from(i,"utf8")))).toString("hex")};return e.timeout&&(a.timeout=e.timeout),fetch(`${e.server.api_url}/channel/set`,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json; charset=utf-8"}}).then(o).catch(s)}).catch(s)})}function oe(e){if(v)return v;const t=de(e,{transports:["websocket","polling"],withCredentials:!0,reconnectionDelayMax:1e4,reconnectionAttempts:10});return t.on("connect_error",o=>{t.io.opts.transports=["polling","websocket"],l.error("connect error",o)}),t.on("connect",async()=>{const{engine:o}=t.io;l.debug("initially connected to",o.transport.name),o.once("upgrade",()=>{l.debug("upgraded",o.transport.name)}),o.once("close",s=>{l.debug("connection closed",s)})}),t.on("error",o=>{l.error("socket errored",o),t.disconnect()}),v=t,t}function ne(e,t,o){const s=oe(e),n=B(t.channelName),r=E(Buffer.from(n,"utf8")),i=z(r).toString("hex");s.connected?s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin}):s.once("connect",()=>{l.debug("connected with socket"),s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})});const a=()=>{s.once("connect",async()=>{y.has(t.channelName)&&s.emit("v2:check_auth_status",i,{sameIpCheck:!0,allowedOrigin:t.server.allowed_origin})})},u=()=>{if(!s||!y.has(t.channelName)){document.removeEventListener("visibilitychange",u);return}!s.connected&&document.visibilityState==="visible"&&a()},d=async g=>{try{const m=await me(r.toString("hex"),g);l.info(m),o(m)}catch(m){l.error(m)}};return s.on("disconnect",()=>{l.debug("socket disconnected"),y.has(t.channelName)&&(l.error("socket disconnected unexpectedly, reconnecting socket"),a())}),s.on(`${i}_success`,d),typeof document<"u"&&document.addEventListener("visibilitychange",u),s}function Ye(){v&&v.disconnect()}function Ge(){return!0}function Qe(e,t){t=k(t);const o=w(),s=new C(t.server.removeTimeout),n={channelName:e,uuid:o,eMIs:s,server:{api_url:t.server.api_url,socket_url:t.server.socket_url,allowed_origin:t.server.allowed_origin},time:h()};return t.server.timeout&&(n.timeout=t.server.timeout),ne(t.server.socket_url,n,r=>{n.messagesCallback&&r.uuid!==n.uuid&&(!r.token||n.eMIs.has(r.token)||(n.eMIs.add(r.token),n.messagesCallback(r.data)))}),y.add(e),n}function Ze(e){y.delete(e.channelName)}function et(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t}function tt(){return 500}const st=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:tt,canBeUsed:Ge,close:Ze,create:Qe,getSocketInstance:oe,microSeconds:qe,onMessage:et,postMessage:Xe,removeStorageEventListener:Ye,setupSocketConnection:ne,storageKey:B,type:se},Symbol.toStringTag,{value:"Module"})),ot=h,P="simulate",N=new Set,D=5;function nt(e){const t={time:h(),name:e,messagesCallback:null};return N.add(t),t}function rt(e){N.delete(e)}function it(e,t){return new Promise(o=>{setTimeout(()=>{Array.from(N).forEach(n=>{n.name===e.name&&n!==e&&n.messagesCallback&&n.time<t.time&&n.messagesCallback(t)}),o()},D)})}function at(e,t){e.messagesCallback=t}function ct(){return!0}function ut(){return D}const dt=Object.freeze(Object.defineProperty({__proto__:null,SIMULATE_DELAY_TIME:D,averageResponseTime:ut,canBeUsed:ct,close:rt,create:nt,microSeconds:ot,onMessage:at,postMessage:it,type:P},Symbol.toStringTag,{value:"Module"})),x=[We,Te,Ae,st];function lt(e){let t=[].concat(e.methods||[],x).filter(Boolean);if(e.type){if(e.type==="simulate")return dt;const s=t.find(n=>n.type===e.type);if(s)return s;throw new Error(`method-type ${e.type} not found`)}e.webWorkerSupport||(t=t.filter(s=>s.type!=="idb"));const o=t.find(s=>s.canBeUsed(e));if(o)return o;throw new Error(`No useable method found in ${JSON.stringify(x.map(s=>s.type))}`)}const O=new Set;let ft=0,re=class{constructor(t,o){c(this,"id",void 0),c(this,"name",void 0),c(this,"options",void 0),c(this,"method",void 0),c(this,"closed",void 0),c(this,"_addEL",void 0),c(this,"_prepP",void 0),c(this,"_state",void 0),c(this,"_uMP",void 0),c(this,"_iL",void 0),c(this,"_onML",void 0),c(this,"_befC",void 0),this.id=ft++,O.add(this),this.name=t,this.options=k(o||{}),this.method=lt(this.options),this.closed=!1,this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,mt(this)}get type(){return this.method.type}get isClosed(){return this.closed}set onmessage(t){const s={time:this.method.microSeconds(),fn:t};U(this,"message",this._onML),t&&typeof t=="function"?(this._onML=s,K(this,"message",s)):this._onML=null}postMessage(t){if(this.closed)throw new Error(`BroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);return A(this,"message",t)}postInternal(t){return A(this,"internal",t)}addEventListener(t,o){const n={time:this.method.microSeconds(),fn:o};K(this,t,n)}removeEventListener(t,o){const s=this._addEL[t].find(n=>n.fn===o);U(this,t,s)}close(){if(this.closed)return Promise.resolve();O.delete(this),this.closed=!0;const t=this._prepP?this._prepP:p;return this._onML=null,this._addEL.message=[],t.then(()=>Promise.all(Array.from(this._uMP))).then(()=>Promise.all(this._befC.map(o=>o()))).then(()=>this.method.close?this.method.close(this._state):p)}};c(re,"_pubkey",!0);function A(e,t,o){const n={time:e.method.microSeconds(),type:t,data:o};return(e._prepP?e._prepP:p).then(()=>{const i=e.method.postMessage(e._state,n);return e._uMP.add(i),i.catch(()=>{}).then(()=>e._uMP.delete(i)),i})}function mt(e){const t=e.method.create(e.name,e.options);if(ge(t)){const o=t;e._prepP=o,o.then(s=>(e._state=s,s)).catch(s=>{throw s})}else e._state=t}function ie(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function ht(e){if(!e._iL&&ie(e)){const t=s=>{e._addEL[s.type].forEach(n=>{(s.time>=n.time||e.method.type==="server")&&n.fn(s.data)})},o=e.method.microSeconds();e._prepP?e._prepP.then(()=>(e._iL=!0,e.method.onMessage(e._state,t,o),!0)).catch(s=>{throw s}):(e._iL=!0,e.method.onMessage(e._state,t,o))}}function gt(e){if(e._iL&&!ie(e)){e._iL=!1;const t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}function K(e,t,o){e._addEL[t].push(o),ht(e)}function U(e,t,o){o&&(e._addEL[t]=e._addEL[t].filter(s=>s!==o),gt(e))}class Mt{constructor(t,o={}){c(this,"name",void 0),c(this,"options",void 0),c(this,"closed",void 0),c(this,"onML",void 0),c(this,"methodPriority",void 0),c(this,"channels",void 0),c(this,"listeners",void 0),c(this,"processedNonces",void 0),c(this,"nonce",void 0),this.name=t,this.options=o,this.closed=!1,this.onML=null,this.methodPriority=[te,G,se],this.channels=new Map,this.listeners=new Set,this.processedNonces=new Set,this.nonce=0,this.initChannels()}set onmessage(t){this.removeEventListener("message",this.onML),t&&typeof t=="function"?(this.onML=t,this.addEventListener("message",t)):this.onML=null}initChannels(){if(this.options.type===P&&(this.methodPriority=[P]),this.methodPriority.forEach(t=>{try{const o=new re(this.name,R(R({},this.options),{},{type:t}));this.channels.set(t,o),l.debug(`Succeeded to initialize ${t} method in channel ${this.name}`),o.onmessage=s=>this.handleMessage(s)}catch(o){l.warn(`Failed to initialize ${t} method in channel ${this.name}: ${o instanceof Error?o.message:String(o)}`)}}),this.channels.size===0)throw new Error("Failed to initialize any communication method")}allChannels(){return Array.from(this.channels.keys())}hasChannel(t){return this.channels.has(t)}handleMessage(t){if(t&&t.nonce){if(this.processedNonces.has(t.nonce))return;if(this.processedNonces.add(t.nonce),this.processedNonces.size>1e3){const s=Array.from(this.processedNonces).sort()[0];this.processedNonces.delete(s)}this.listeners.forEach(o=>{o(t.message)})}}async postMessage(t){if(this.closed)throw new Error(`AdaptiveBroadcastChannel.postMessage(): Cannot post message after channel has closed ${JSON.stringify(t)}`);const s={nonce:this.generateNonce(),message:t},n=Array.from(this.channels.entries()).map(([a,u])=>u.postMessage(s).catch(d=>{throw l.warn(`Failed to send via ${a}: ${d.message}`),d}));if(!(await Promise.allSettled(n)).some(a=>a.status==="fulfilled"))throw new Error("Failed to send message through any method");return t}generateNonce(){return`${Date.now()}-${this.nonce++}`}addEventListener(t,o){this.listeners.add(o)}removeEventListener(t,o){this.listeners.delete(o)}async close(){if(this.closed)return;this.onML=null;const t=[];for(const o of this.channels.values())t.push(o.close());await Promise.all(t),this.channels.clear(),this.listeners.clear(),this.closed=!0}}export{re as BroadcastChannel,Te as IndexedDbMethod,Ae as LocalstorageMethod,We as NativeMethod,O as OPEN_BROADCAST_CHANNELS,Mt as RedundantAdaptiveBroadcastChannel,st as ServerMethod,lt as chooseMethod};
